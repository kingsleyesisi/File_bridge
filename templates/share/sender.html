<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Room: {{ session['Room_Name'] }} - FileBridge</title>
    <link rel="stylesheet" href="static/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/edec7f25e3.js" crossorigin="anonymous"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.slim.min.js" crossorigin="anonymous"></script>
    <link rel="shortcut icon" href="../../static/Filebridge.png" type="image/x-icon">
</head>

<body class="chat-body">
    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header-new">
            <div class="header-left">
                <div class="room-avatar">
                    <i class="fas fa-hashtag"></i>
                </div>
                <div class="room-details">
                    <h3 class="room-name">{{ session['Room_Name'] }}</h3>
                    <span class="room-status" id="online-status">
                        <span class="status-dot"></span>
                        <span id="user-count-header">1</span> online
                    </span>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" id="users-toggle" title="Toggle Users Panel">
                    <i class="fas fa-users"></i>
                </button>
                <button class="header-btn leave-btn" id="leave-room-btn" title="Leave Room">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main-new">
            <!-- Users Sidebar -->
            <div class="users-panel" id="users-panel">
                <div class="users-panel-header">
                    <h4><i class="fas fa-users"></i> Online Users</h4>
                    <span class="users-count" id="users-count">1</span>
                </div>
                <div class="users-list-new" id="users-list"></div>
            </div>

            <!-- Messages Area -->
            <div class="messages-area">
                <div class="messages-container" id="chat-messages">
                    <div class="welcome-card">
                        <div class="welcome-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h4>Welcome to {{ session['Room_Name'] }}!</h4>
                        <p>You're connected as <strong>{{ session['username'] }}</strong></p>
                        <div class="welcome-features">
                            <div class="feature-item">
                                <i class="fas fa-file-upload"></i>
                                <span>Share files up to 50MB</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-comments"></i>
                                <span>Real-time messaging</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-link"></i>
                                <span>Shareable file links</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typing-indicator" style="display: none;">
                    <div class="typing-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="typing-content">
                        <span class="typing-text" id="typing-text">Someone is typing</span>
                        <div class="typing-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="message-input-area">
                    <div class="input-container">
                        <div class="file-upload-section">
                            <input type="file" id="fileinput" style="display: none;" accept="*/*" multiple />
                            <label for="fileinput" class="file-upload-btn" title="Upload Files (Max 50MB each)">
                                <i class="fas fa-paperclip"></i>
                            </label>
                        </div>
                        
                        <div class="text-input-section">
                            <textarea
                                id="sendinput"
                                placeholder="Type your message or drag files here..."
                                maxlength="10000"
                                rows="1"
                            ></textarea>
                        </div>
                        
                        <div class="send-section">
                            <button class="send-btn" id="send-btn" title="Send Message">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-hints">
                        <span class="hint">
                            <i class="fas fa-info-circle"></i>
                            Press Enter to send, Shift+Enter for new line
                        </span>
                        <span class="file-hint">
                            <i class="fas fa-file-upload"></i>
                            Drag & drop files or click the paperclip
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Room Modal -->
    <dialog class="modal-new" id="leave-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Leave Room?</h3>
                <button class="modal-close" id="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to leave <strong>{{ session['Room_Name'] }}</strong>?</p>
                <p class="modal-note">You'll need to rejoin to continue the conversation.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-leave">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="btn-danger" id="confirm-leave">
                    <i class="fas fa-sign-out-alt"></i>
                    Leave Room
                </button>
            </div>
        </div>
    </dialog>

    <script>
        $(document).ready(() => {
            let socket = io.connect("/sender");
            let typingTimer;
            let isTyping = false;
            
            // Toggle users panel on mobile
            $("#users-toggle").click(() => {
                $("#users-panel").toggleClass("active");
            });

            // Connection handling
            socket.on("connect", () => {
                socket.emit("sender", {});
            });

            // Status messages
            socket.on("status", (data) => {
                addSystemMessage(data.msg, data.type || "info");
            });
            
            // User list updates
            socket.on("user_list_update", (data) => {
                updateUserCount(data.user_count);
                updateActiveUsers(data.users);
            });
            
            // Typing indicator updates
            socket.on("typing_update", (data) => {
                updateTypingIndicator(data.typing_users);
            });

            // Send message
            $("#send-btn").click((e) => {
                e.preventDefault();
                sendMessage();
            });

            $("#sendinput").keydown((e) => {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            $("#sendinput").on('input', handleTyping);
            $("#sendinput").on('input', autoResizeTextarea);
            
            function autoResizeTextarea() {
                const textarea = $("#sendinput")[0];
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            function sendMessage() {
                const text = $("#sendinput").val().trim();
                if (text) {
                    $("#sendinput").val("");
                    autoResizeTextarea();
                    socket.emit("text", { msg: text });
                    stopTyping();
                }
            }
            
            function handleTyping() {
                if (!isTyping) {
                    isTyping = true;
                    socket.emit("typing", { typing: true, action: 'typing' });
                }
                
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    stopTyping();
                }, 2000);
            }
            
            function stopTyping() {
                if (isTyping) {
                    isTyping = false;
                    socket.emit("typing", { typing: false, action: 'stopped' });
                }
                clearTimeout(typingTimer);
            }

            // Handle incoming messages
            socket.on("message", (data) => {
                if (data.message_type === 'file') {
                    displayFileMessage(data);
                } else {
                    displayTextMessage(data);
                }
            });

            // File upload handling
            $("#fileinput").change((e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    socket.emit("typing", { typing: true, action: 'uploading_files' });
                    
                    files.forEach((file, index) => {
                        setTimeout(() => {
                            uploadFile(file);
                        }, index * 500);
                    });
                    
                    $("#fileinput").val("");
                    
                    setTimeout(() => {
                        socket.emit("typing", { typing: false, action: 'stopped' });
                    }, files.length * 500 + 1000);
                }
            });
            
            function uploadFile(file) {
                const maxSize = 50 * 1024 * 1024;
                if (file.size > maxSize) {
                    addSystemMessage(`File "${file.name}" exceeds 50MB limit.`, "error");
                    return;
                }

                addSystemMessage(`Uploading ${file.name}...`, "info");
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    socket.emit("file", { 
                        file: event.target.result, 
                        fileName: file.name, 
                        fileType: file.type,
                        fileSize: file.size
                    });
                };
                reader.readAsDataURL(file);
            }

            // Leave room functionality
            $("#leave-room-btn").click(() => {
                $("#leave-modal")[0].showModal();
            });

            $("#modal-close, #cancel-leave").click(() => {
                $("#leave-modal")[0].close();
            });

            $("#confirm-leave").click(() => {
                socket.emit("left", {}, () => {
                    socket.disconnect();
                    window.location.href = "/receiver";
                });
            });

            // Helper functions
            function displayTextMessage(data) {
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const isCode = data.message_type === 'code';
                const processedContent = processMessageContent(data.content);
                
                const messageElement = $(`
                    <div class="message-item ${isCode ? 'code-message' : 'text-message'}">
                        <div class="message-avatar" style="background: ${data.user_color};">
                            ${data.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-username" style="color: ${data.user_color};">${data.username}</span>
                                <span class="message-time">${timestamp}</span>
                            </div>
                            <div class="message-text ${isCode ? 'code-block' : ''}">${processedContent}</div>
                            ${isCode ? '<button class="copy-code-btn"><i class="fas fa-copy"></i> Copy</button>' : ''}
                        </div>
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);
                scrollToBottom();
                
                if (isCode) {
                    messageElement.find('.copy-code-btn').click(function() {
                        navigator.clipboard.writeText(data.content).then(() => {
                            $(this).html('<i class="fas fa-check"></i> Copied!');
                            setTimeout(() => {
                                $(this).html('<i class="fas fa-copy"></i> Copy');
                            }, 2000);
                        });
                    });
                }
            }
            
            function processMessageContent(content) {
                let processed = escapeHtml(content);
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                processed = processed.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                const emailRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;
                processed = processed.replace(emailRegex, '<a href="mailto:$1">$1</a>');
                return processed;
            }

            function displayFileMessage(data) {
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const fileSize = formatFileSize(data.file_size || 0);
                
                const messageElement = $(`
                    <div class="message-item file-message">
                        <div class="message-avatar" style="background: ${data.user_color};">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-username" style="color: ${data.user_color};">${data.username}</span>
                                <span class="message-time">${timestamp}</span>
                            </div>
                            <div class="file-card">
                                <div class="file-info">
                                    <div class="file-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="file-details">
                                        <div class="file-name">${data.filename}</div>
                                        <div class="file-size">${fileSize}</div>
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <a href="/download_temp/${data.file_id}" class="file-btn download-btn">
                                        <i class="fas fa-download"></i>
                                        Download
                                    </a>
                                    <button class="file-btn copy-link-btn" data-link="${data.shareable_link}">
                                        <i class="fas fa-link"></i>
                                        Copy Link
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);
                scrollToBottom();
                
                messageElement.find('.copy-link-btn').click(function() {
                    const link = $(this).data('link');
                    navigator.clipboard.writeText(link).then(() => {
                        $(this).html('<i class="fas fa-check"></i> Copied!');
                        setTimeout(() => {
                            $(this).html('<i class="fas fa-link"></i> Copy Link');
                        }, 2000);
                    });
                });
            }

            function addSystemMessage(message, type) {
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const icon = type === 'join' ? 'user-plus' : type === 'leave' ? 'user-minus' : 
                           type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
                
                const messageElement = $(`
                    <div class="system-message ${type}">
                        <div class="system-content">
                            <i class="fas fa-${icon}"></i>
                            <span>${message}</span>
                            <span class="system-time">${timestamp}</span>
                        </div>
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);
                scrollToBottom();
                
                if (type === 'success' || type === 'error' || type === 'info') {
                    setTimeout(() => {
                        messageElement.fadeOut(() => messageElement.remove());
                    }, 5000);
                }
            }
            
            function updateUserCount(count) {
                $("#user-count-header").text(count);
                $("#users-count").text(count);
            }
            
            function updateActiveUsers(users) {
                const usersList = $("#users-list");
                usersList.empty();
                
                if (users.length === 0) {
                    usersList.append('<div class="no-users">Only you are online</div>');
                    return;
                }
                
                users.forEach(user => {
                    const userElement = $(`
                        <div class="user-item">
                            <div class="user-avatar">
                                ${user.charAt(0).toUpperCase()}
                            </div>
                            <div class="user-info">
                                <span class="user-name">${user}</span>
                                <span class="user-status">Online</span>
                            </div>
                            <div class="status-indicator"></div>
                        </div>
                    `);
                    usersList.append(userElement);
                });
            }
            
            function updateTypingIndicator(typingUsers) {
                const indicator = $("#typing-indicator");
                const typingText = $("#typing-text");
                
                if (typingUsers.length === 0) {
                    indicator.hide();
                } else if (typingUsers.length === 1) {
                    const user = typingUsers[0];
                    const action = user.action === 'uploading_files' ? 'uploading files' : 'typing';
                    typingText.text(`${user.username} is ${action}...`);
                    indicator.show();
                } else if (typingUsers.length === 2) {
                    typingText.text(`${typingUsers[0].username} and ${typingUsers[1].username} are typing...`);
                    indicator.show();
                } else {
                    typingText.text(`${typingUsers.length} people are typing...`);
                    indicator.show();
                }
            }
            
            function scrollToBottom() {
                const container = $("#chat-messages");
                container.scrollTop(container[0].scrollHeight);
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Connection error handling
            socket.on("connect_error", () => {
                addSystemMessage("Connection failed. Please try again.", "error");
            });

            socket.on("disconnect", () => {
                addSystemMessage("Disconnected from room.", "error");
            });

            // Drag and drop file upload
            const messagesArea = $(".messages-area");
            
            messagesArea.on('dragover', (e) => {
                e.preventDefault();
                messagesArea.addClass('drag-over');
            });
            
            messagesArea.on('dragleave', (e) => {
                e.preventDefault();
                messagesArea.removeClass('drag-over');
            });
            
            messagesArea.on('drop', (e) => {
                e.preventDefault();
                messagesArea.removeClass('drag-over');
                
                const files = Array.from(e.originalEvent.dataTransfer.files);
                if (files.length > 0) {
                    socket.emit("typing", { typing: true, action: 'uploading_files' });
                    
                    files.forEach((file, index) => {
                        setTimeout(() => {
                            uploadFile(file);
                        }, index * 500);
                    });
                    
                    setTimeout(() => {
                        socket.emit("typing", { typing: false, action: 'stopped' });
                    }, files.length * 500 + 1000);
                }
            });
        });
    </script>
</body>
</html>