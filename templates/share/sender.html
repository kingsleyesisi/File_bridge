<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Room: {{ session['Room_Name'] }} - FileBridge</title>
    <link rel="stylesheet" href="static/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/edec7f25e3.js" crossorigin="anonymous"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.slim.min.js" crossorigin="anonymous"></script>
    <link rel="prefetch" href="/main">
    <link rel="prefetch" href="/receiver">
    <link rel="prefetch" href="/instructions">
    <link rel="prefetch" href="/about">
    <link rel="preload" href="/static/styles.css" as="style">
    <link rel="preload" href="/static/app.js" as="script">
    <link rel="shortcut icon" href="../../static/Filebridge.png" type="image/x-icon">
</head>

<body>
    <header>
        <h1><i class="fas fa-cloud-upload-alt"></i> FileBridge</h1>
    </header>

    <div class="main-container">
        <div class="room-header">
            <h2>
                <i class="fas fa-users"></i>
                Room: {{ session['Room_Name'] }}
            </h2>
            <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                Welcome, <strong>{{ session['username'] }}</strong>! Share files and chat with room members.
            </p>
            <div id="room-info" style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div id="user-count" style="background: var(--primary-color); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem;">
                    <i class="fas fa-users"></i> <span id="count">1</span> user(s) online
                </div>
            </div>
        </div>

        <div id="sending-page">
            <!-- Chat Interface -->
            <div class="chat-interface">
                <!-- Active Users Sidebar -->
                <div class="users-sidebar">
                    <div class="sidebar-header">
                        <i class="fas fa-users"></i>
                        <span>Active Users</span>
                    </div>
                    <div id="users-list" class="users-list"></div>
                </div>

                <!-- Main Chat Area -->
                <div class="chat-main">
                    <div class="chat-header">
                        <div class="room-info">
                            <h3>{{ session['Room_Name'] }}</h3>
                            <span id="online-status"><span id="count">1</span> online</span>
                        </div>
                        <button class="leave-room-btn" id="leave-room-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Leave</span>
                        </button>
                    </div>

                    <div class="chat-messages-container">
                        <div id="chat-messages" class="chat-messages">
                            <div class="welcome-message">
                                <div class="welcome-icon">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <h4>Welcome to {{ session['Room_Name'] }}!</h4>
                                <p>Start chatting and sharing files with room members.</p>
                            </div>
                        </div>
                        
                        <!-- Typing Indicator -->
                        <div id="typing-indicator-container" class="typing-indicator-container">
                            <div class="typing-bubble">
                                <div class="typing-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="typing-content">
                                    <div class="typing-text" id="typing-text">Someone is typing</div>
                                    <div class="typing-dots">
                                        <span class="dot"></span>
                                        <span class="dot"></span>
                                        <span class="dot"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="message-input-container">
                        <div class="input-wrapper">
                            <textarea
                                id="sendinput"
                                placeholder="Type your message here..."
                                maxlength="10000"
                                rows="1"
                            ></textarea>
                            
                            <div class="input-actions">
                                <input type="file" id="fileinput" style="display: none;" accept="*/*" multiple />
                                <label for="fileinput" class="file-upload-btn" title="Upload Files (Max 50MB each)">
                                    <i class="fas fa-paperclip"></i>
                                </label>
                                
                                <button class="send-button" id="send-btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Room Modal -->
    <dialog class="modal" id="modal">
        <h2>Leave Room?</h2>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">
            Are you sure you want to leave this room? You'll need to rejoin to continue the conversation.
        </p>
        <div class="modal-buttons">
            <button class="close-button-modal close-button">
                <i class="fas fa-times"></i>
                Cancel
            </button>
            <button class="leave-btn" id="leave-btn">
                <i class="fas fa-sign-out-alt"></i>
                Leave Room
            </button>
        </div>
    </dialog>

    <footer id="footer">
        <div>
            <a href="/main">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
        </div>
        <div class="active">
            <a href="/receiver">
                <i class="fas fa-share-alt"></i>
                <span>Transfer</span>
            </a>
        </div>
        <div>
            <a href="/instructions">
                <i class="fas fa-book-open"></i>
                <span>Guide</span>
            </a>
        </div>
        <div>
            <a href="/about">
                <i class="fas fa-user-group"></i>
                <span>About</span>
            </a>
        </div>
    </footer>

    <script>
        // Enhanced Socket.IO implementation with better file handling
        $(document).ready(() => {
            let socket = io.connect("/sender");
            let typingTimer;
            let isTyping = false;
            
            // Connection handling
            socket.on("connect", () => {
                socket.emit("sender", {});
            });

            // Status messages
            socket.on("status", (data) => {
                addSystemMessage(data.msg, data.type || "info");
            });
            
            // User list updates
            socket.on("user_list_update", (data) => {
                updateUserCount(data.user_count);
                updateActiveUsers(data.users);
            });
            
            // Typing indicator updates
            socket.on("typing_update", (data) => {
                updateTypingIndicator(data.typing_users);
            });

            // Send message
            $("#send-btn").click((e) => {
                e.preventDefault();
                sendMessage();
            });

            $("#sendinput").keydown((e) => {
                if (e.which === 13 && !e.shiftKey) { // Enter key without Shift
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            $("#sendinput").on('input', handleTyping);
            $("#sendinput").on('input', autoResizeTextarea);
            
            function autoResizeTextarea() {
                const textarea = $("#sendinput")[0];
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            function sendMessage() {
                const text = $("#sendinput").val().trim();
                if (text) {
                    $("#sendinput").val("");
                    autoResizeTextarea();
                    socket.emit("text", { msg: text });
                    stopTyping();
                }
            }
            
            function handleTyping() {
                if (!isTyping) {
                    isTyping = true;
                    socket.emit("typing", { typing: true, action: 'typing' });
                }
                
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    stopTyping();
                }, 2000);
            }
            
            function stopTyping() {
                if (isTyping) {
                    isTyping = false;
                    socket.emit("typing", { typing: false, action: 'stopped' });
                }
                clearTimeout(typingTimer);
            }

            // Handle incoming messages
            socket.on("message", (data) => {
                if (data.message_type === 'file') {
                    displayFileMessage(data);
                } else {
                    displayTextMessage(data);
                }
            });

            // File upload handling
            $("#fileinput").change((e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    // Show file selection indicator
                    socket.emit("typing", { typing: true, action: 'selecting_files' });
                    
                    files.forEach((file, index) => {
                        setTimeout(() => {
                            uploadFile(file);
                        }, index * 500); // Stagger uploads
                    });
                    
                    $("#fileinput").val("");
                    
                    // Stop file selection indicator after uploads
                    setTimeout(() => {
                        socket.emit("typing", { typing: false, action: 'stopped' });
                    }, files.length * 500 + 1000);
                }
            });
            
            function uploadFile(file) {
                // Check file size (50MB limit)
                const maxSize = 50 * 1024 * 1024; // 50MB in bytes
                if (file.size > maxSize) {
                    addSystemMessage(`File "${file.name}" exceeds 50MB limit. Please choose a smaller file.`, "error");
                    return;
                }

                addSystemMessage(`Uploading ${file.name}...`, "info");
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    socket.emit("file", { 
                        file: event.target.result, 
                        fileName: file.name, 
                        fileType: file.type,
                        fileSize: file.size
                    });
                };
                reader.readAsDataURL(file);
            }

            // Leave room functionality
            $("#leave-room-btn").click(() => {
                $("#modal").get(0).showModal();
            });

            $(".close-button").click(() => {
                $("#modal").get(0).close();
            });

            $(".leave-btn").click(() => {
                socket.emit("left", {}, () => {
                    socket.disconnect();
                    window.location.href = "/receiver";
                });
            });

            // Helper functions
            function displayTextMessage(data) {
                const timestamp = new Date().toLocaleTimeString();
                const isCode = data.message_type === 'code';
                const processedContent = processMessageContent(data.content);
                
                const messageElement = $(`
                    <div class="message ${isCode ? 'code-message' : 'text-message'}">
                        <div class="message-avatar" style="background: ${data.user_color};">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="message-bubble">
                            <div class="message-header">
                                <span class="username" style="color: ${data.user_color};">${data.username}</span>
                                <span class="timestamp">${timestamp}</span>
                            </div>
                            <div class="message-content ${isCode ? 'code-content' : 'text-content'}">${processedContent}</div>
                            ${isCode ? '<div class="code-actions"><button class="copy-code-btn"><i class="fas fa-copy"></i> Copy Code</button></div>' : ''}
                        </div>
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);
                scrollToBottom();
                
                // Add copy functionality for code blocks
                if (isCode) {
                    messageElement.find('.copy-code-btn').click(function() {
                        navigator.clipboard.writeText(data.content).then(() => {
                            $(this).html('<i class="fas fa-check"></i> Copied!');
                            setTimeout(() => {
                                $(this).html('<i class="fas fa-copy"></i> Copy Code');
                            }, 2000);
                        });
                    });
                }
            }
            
            function processMessageContent(content) {
                // First escape HTML to prevent XSS
                let processed = escapeHtml(content);
                
                // Convert URLs to clickable links
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                processed = processed.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color); text-decoration: underline;">$1</a>');
                
                // Convert email addresses to clickable links
                const emailRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;
                processed = processed.replace(emailRegex, '<a href="mailto:$1" style="color: var(--primary-color); text-decoration: underline;">$1</a>');
                
                return processed;
            }

            function displayFileMessage(data) {
                const timestamp = new Date().toLocaleTimeString();
                const fileSize = formatFileSize(data.file_size || 0);
                
                const messageElement = $(`
                    <div class="message file-message">
                        <div class="message-avatar" style="background: ${data.user_color};">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="message-bubble">
                            <div class="message-header">
                                <span class="username" style="color: ${data.user_color};">${data.username}</span>
                                <span class="timestamp">${timestamp}</span>
                            </div>
                            <div class="file-content">
                                <div class="file-info">
                                    <div class="file-icon">
                                        <i class="fas fa-file"></i>
                                    </div>
                                    <div class="file-details">
                                        <div class="file-name">${data.filename}</div>
                                        <div class="file-size">${fileSize}</div>
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <a href="/download_temp/${data.file_id}" class="download-btn">
                                        <i class="fas fa-download"></i>
                                        <span>Download</span>
                                    </a>
                                    <button class="copy-link-btn" data-link="${data.shareable_link}">
                                        <i class="fas fa-link"></i>
                                        <span>Copy Link</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);
                scrollToBottom();
                
                // Add copy link functionality
                messageElement.find('.copy-link-btn').click(function() {
                    const link = $(this).data('link');
                    navigator.clipboard.writeText(link).then(() => {
                        $(this).html('<i class="fas fa-check"></i> Copied!');
                        setTimeout(() => {
                            $(this).html('<i class="fas fa-link"></i> Copy Link');
                        }, 2000);
                    });
                });
            }

            function addSystemMessage(message, type) {
                const timestamp = new Date().toLocaleTimeString();
                const icon = type === 'join' ? 'user-plus' : type === 'leave' ? 'user-minus' : type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
                const color = type === 'join' ? 'var(--success-color)' : type === 'leave' ? 'var(--error-color)' : type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--error-color)' : 'var(--text-secondary)';
                
                const messageElement = $(`
                    <div class="system-message">
                        <div class="system-content">
                            <i class="fas fa-${icon}" style="color: ${color};"></i>
                            <span>${message}</span>
                            <span class="system-time">${timestamp}</span>
                        </div>
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);
                scrollToBottom();
                
                // Auto-remove status messages after 5 seconds
                if (type === 'success' || type === 'error') {
                    setTimeout(() => {
                        messageElement.fadeOut(() => messageElement.remove());
                    }, 5000);
                }
            }
            
            function updateUserCount(count) {
                $("#count").text(count);
                $("#online-status span").text(count);
            }
            
            function updateActiveUsers(users) {
                const usersList = $("#users-list");
                usersList.empty();
                
                if (users.length === 0) {
                    usersList.append('<div class="no-users">No other users online</div>');
                    return;
                }
                
                users.forEach(user => {
                    const userElement = $(`
                        <div class="user-item">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="user-name">${user}</span>
                            <div class="user-status online"></div>
                        </div>
                    `);
                    usersList.append(userElement);
                });
            }
            
            function updateTypingIndicator(typingUsers) {
                const indicatorContainer = $("#typing-indicator-container");
                const typingText = $("#typing-text");
                const avatar = $(".typing-avatar i");
                
                if (typingUsers.length === 0) {
                    indicatorContainer.hide();
                } else if (typingUsers.length === 1) {
                    const user = typingUsers[0];
                    const action = user.action === 'selecting_files' ? 'selecting files' : 'typing';
                    const icon = user.action === 'selecting_files' ? 'file-upload' : 'keyboard';
                    
                    avatar.removeClass().addClass(`fas fa-${icon}`);
                    typingText.text(`${user.username} is ${action}`);
                    indicatorContainer.show();
                } else if (typingUsers.length === 2) {
                    avatar.removeClass().addClass('fas fa-users');
                    typingText.text(`${typingUsers[0].username} and ${typingUsers[1].username} are typing`);
                    indicatorContainer.show();
                } else {
                    avatar.removeClass().addClass('fas fa-users');
                    typingText.text(`${typingUsers.length} people are typing`);
                    indicatorContainer.show();
                }
            }
            
            function scrollToBottom() {
                const chatMessages = $("#chat-messages");
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Connection error handling
            socket.on("connect_error", () => {
                addSystemMessage("Connection failed. Please try again.", "error");
            });

            socket.on("disconnect", () => {
                addSystemMessage("Disconnected from room.", "error");
            });
        });
    </script>
</body>
</html>