<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Room: {{ session['Room_Name'] }} - FileBridge</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://kit.fontawesome.com/edec7f25e3.js" crossorigin="anonymous"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.slim.min.js" crossorigin="anonymous"></script>
    <link rel="shortcut icon" href="{{ url_for('static', filename='Filebridge.png') }}" type="image/x-icon">
</head>

<body class="chat-body">
    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header-new">
            <div class="header-left">
                <div class="room-avatar">
                    <i class="fas fa-hashtag"></i>
                </div>
                <div class="room-details">
                    <h3 class="room-name">{{ session['Room_Name'] }}</h3>
                    <span class="room-status" id="online-status">
                        <span class="status-dot"></span>
                        <span id="user-count-header">1</span> online
                    </span>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn hamburger-menu" id="hamburger-menu" title="Toggle Users Panel">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="header-btn desktop-only" id="users-toggle" title="Toggle Users Panel">
                    <i class="fas fa-users"></i>
                </button>
                <button class="header-btn" id="notifications-toggle" title="Toggle Notifications">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="header-btn leave-btn" id="leave-room-btn" title="Leave Room">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- Custom Notification Toast -->
        <div id="notification-toast" class="notification-toast"></div>

        <!-- Main Chat Area -->
        <div class="chat-main-new">
            <div class="mobile-overlay" id="mobile-overlay"></div>
            <!-- Messages Area -->
            <div class="messages-area">
                <div class="messages-container" id="chat-messages">
                    <div class="welcome-card">
                        <div class="welcome-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h4>Welcome to {{ session['Room_Name'] }}!</h4>
                        <p>You're connected as <strong>{{ session['username'] }}</strong></p>
                        <div class="welcome-features">
                            <div class="feature-item">
                                <i class="fas fa-file-upload"></i>
                                <span>Share files up to 2GB</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-comments"></i>
                                <span>Real-time messaging</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-link"></i>
                                <span>Shareable file links</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typing-indicator" style="display: none;">
                    <div class="typing-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="typing-content">
                        <span class="typing-text" id="typing-text">Someone is typing</span>
                        <div class="typing-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="message-input-area">
                    <div class="input-container">
                        <div class="file-upload-section">
                            <input type="file" id="fileinput" style="display: none;" accept="*/*" multiple />
                            <label for="fileinput" class="file-upload-btn" title="Upload Files (Max 2GB each)">
                                <i class="fas fa-paperclip"></i>
                            </label>
                        </div>
                        
                        <div class="text-input-section">
                            <textarea
                                id="sendinput"
                                placeholder="Type your message or drag files here..."
                                maxlength="10000"
                                rows="1"
                            ></textarea>
                        </div>
                        
                        <div class="send-section">
                            <button class="send-btn" id="send-btn" title="Send Message">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-hints">
                        <span class="hint">
                            <i class="fas fa-info-circle"></i>
                            Press Enter to send, Shift+Enter for new line
                        </span>
                        <span class="file-hint">
                            <i class="fas fa-file-upload"></i>
                            Drag & drop files or click the paperclip
                        </span>
                    </div>
                </div>
            </div>

            <!-- Users Sidebar -->
            <div class="users-panel" id="users-panel">
                <div class="users-panel-header">
                    <h4><i class="fas fa-users"></i> Online Users</h4>
                    <span class="users-count" id="users-count">1</span>
                </div>
                <div class="users-list-new" id="users-list"></div>
            </div>
        </div>
    </div>

    <!-- Notification Sound -->
    <audio id="notification-sound" src="/static/notification.wav" preload="auto"></audio>

    <!-- Leave Room Modal -->
    <dialog class="modal-new" id="leave-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Leave Room?</h3>
                <button class="modal-close" id="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to leave <strong>{{ session['Room_Name'] }}</strong>?</p>
                <p class="modal-note">You'll need to rejoin to continue the conversation.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-leave">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="btn-danger" id="confirm-leave">
                    <i class="fas fa-sign-out-alt"></i>
                    Leave Room
                </button>
            </div>
        </div>
    </dialog>

    <script>
        $(document).ready(() => {
            let socket = io.connect("/sender");
            let typingTimer;
            let isTyping = false;
            
            // Toggle users panel
            $("#users-toggle, #hamburger-menu").click(() => {
                $("#users-panel").toggleClass("active");
                $("#mobile-overlay").toggleClass("active");
            });

            // Also hide panel when overlay is clicked
            $("#mobile-overlay").click(() => {
                $("#users-panel").removeClass("active");
                $("#mobile-overlay").removeClass("active");
            });

            // Connection handling
            socket.on("connect", () => {
                socket.emit("sender", {});
            });

            // Load history sent from server on join
            socket.on("history", (payload) => {
                try {
                    const messages = (payload && payload.messages) || [];
                    if (messages.length > 0) {
                        $(".welcome-card").remove();
                    }
                    messages.forEach((m) => {
                        if (m.message_type === 'file') {
                            displayFileMessage(m);
                        } else {
                            displayTextMessage(m);
                        }
                    });
                } catch (err) {
                    console.error('Failed to render history', err);
                }
            });

            function showLocalNotification(title, body) {
                if (notificationsEnabled && document.hidden) {
                    new Notification(title, { body: body, icon: '/static/Filebridge.png' });
                }
            }

            // Status messages
            socket.on("status", (data) => {
                addSystemMessage(data.msg, data.type || "info");
                if (data.type === 'join') {
                    $("#notification-sound")[0].play().catch(e => console.log("Could not play sound:", e));
                    showLocalNotification(`New user in {{ session['Room_Name'] }}`, data.msg);
                }
            });
            
            // User list updates
            socket.on("user_list_update", (data) => {
                updateUserCount(data.user_count);
                updateActiveUsers(data.users);
            });
            
            // Typing indicator updates
            socket.on("typing_update", (data) => {
                updateTypingIndicator(data.typing_users);
            });

            // Send message
            $("#send-btn").click((e) => {
                e.preventDefault();
                sendMessage();
            });

            $("#sendinput").keydown((e) => {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            $("#sendinput").on('input', handleTyping);
            $("#sendinput").on('input', autoResizeTextarea);
            
            function autoResizeTextarea() {
                const textarea = $("#sendinput")[0];
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            function sendMessage() {
                const text = $("#sendinput").val().trim();
                if (text) {
                    $("#sendinput").val("");
                    autoResizeTextarea();
                    socket.emit("text", { msg: text });
                    stopTyping();
                }
            }
            
            function handleTyping() {
                if (!isTyping) {
                    isTyping = true;
                    socket.emit("typing", { typing: true, action: 'typing' });
                }
                
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    stopTyping();
                }, 2000);
            }
            
            function stopTyping() {
                if (isTyping) {
                    isTyping = false;
                    socket.emit("typing", { typing: false, action: 'stopped' });
                }
                clearTimeout(typingTimer);
            }

            // Handle incoming messages
            socket.on("message", (data) => {
                $("#notification-sound")[0].play().catch(e => console.log("Could not play sound:", e));
                if (data.message_type === 'file') {
                    displayFileMessage(data);
                    showLocalNotification(`New file in {{ session['Room_Name'] }}`, `${data.username}: ${data.filename}`);
                } else {
                    displayTextMessage(data);
                    showLocalNotification(`New message in {{ session['Room_Name'] }}`, `${data.username}: ${data.content}`);
                }
            });

            // File upload handling
            $("#fileinput").change((e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    socket.emit("typing", { typing: true, action: 'uploading_files' });
                    
                    files.forEach((file, index) => {
                        setTimeout(() => {
                            uploadFile(file);
                        }, index * 500);
                    });
                    
                    $("#fileinput").val("");
                    
                    setTimeout(() => {
                        socket.emit("typing", { typing: false, action: 'stopped' });
                    }, files.length * 500 + 1000);
                }
            });
            
            function uploadFile(file) {
                const CHUNK_SIZE = 1 * 1024 * 1024; // 1MB
                const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
                const fileId = '{{ session['username'] }}' + '-' + Date.now() + '-' + file.name;
                let chunkIndex = 0;

                addSystemMessage(`Starting upload for ${file.name}...`, "info");

                function sendNextChunk() {
                    if (chunkIndex >= totalChunks) {
                        addSystemMessage(`Finished uploading ${file.name}. Processing...`, "success");
                        return;
                    }

                    const start = chunkIndex * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, file.size);
                    const chunk = file.slice(start, end);

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        socket.emit("file_chunk", {
                            file_id: fileId,
                            chunk: event.target.result,
                            chunk_index: chunkIndex,
                            total_chunks: totalChunks,
                            fileName: file.name,
                            fileType: file.type,
                            fileSize: file.size
                        });

                        // Update progress
                        const progress = Math.round(((chunkIndex + 1) / totalChunks) * 100);
                        // A system message for progress can be spammy, consider a dedicated UI element
                        // For now, we can just log it or have a less intrusive notification
                        console.log(`Upload progress for ${file.name}: ${progress}%`);

                        chunkIndex++;
                        sendNextChunk();
                    };
                    reader.readAsDataURL(chunk);
                }

                sendNextChunk();
            }

            // Leave room functionality
            $("#leave-room-btn").click(() => {
                $("#leave-modal")[0].showModal();
            });

            $("#modal-close, #cancel-leave").click(() => {
                $("#leave-modal")[0].close();
            });

            $("#confirm-leave").click(() => {
                socket.emit("left", {}, () => {
                    socket.disconnect();
                    window.location.href = "/receiver";
                });
            });

            // Helper functions
            function isLongText(text) {
                if (!text) return false;
                const words = text.trim().split(/\s+/);
                return words.length >= 30;
            }

            function displayTextMessage(data) {
                const isMyMessage = data.username === "{{ session['username'] }}";
                const timestamp = formatTimestamp(data && data.timestamp);
                const isCode = data.message_type === 'code';
                const processedContent = processMessageContent(data.content);
                
                const messageElement = $(`
                    <div class="message-item ${isCode ? 'code-message' : 'text-message'} ${isMyMessage ? 'my-message' : ''}">
                        <div class="message-avatar" style="background: ${data.user_color};">
                            ${data.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-username" style="color: ${data.user_color};">${data.username}</span>
                                <span class="message-time">${timestamp}</span>
                            </div>
                            <div class="message-text ${isCode ? 'code-block' : ''}" data-raw="${escapeHtmlAttr(data.content)}">
                                ${processedContent}
                                ${(isCode || isLongText(data.content)) ? '<button class="copy-code-btn" title="Copy"><i class="fas fa-copy"></i></button>' : ''}
                            </div>
                        </div>
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);

                if (isCode) {
                    const codeBlock = messageElement.find('.code-block')[0];
                    if (codeBlock) {
                        hljs.highlightElement(codeBlock);
                    }
                }

                scrollToBottom();
                
                // Copy interactions for code and long text by icon or tapping the message
                if (isCode || isLongText(data.content)) {
                    const copyButton = messageElement.find('.copy-code-btn');
                    const messageBubble = messageElement.find('.message-text');
                    const rawText = data.content;
                    let pressTimer;

                    function handleCopy() {
                        navigator.clipboard.writeText(rawText).then(() => {
                            copyButton.html('<i class="fas fa-check"></i>');
                            copyButton.addClass('copied');
                            setTimeout(() => {
                                copyButton.removeClass('copied');
                                copyButton.html('<i class="fas fa-copy"></i>');
                            }, 1500);
                        });
                    }

                    copyButton.on('click', handleCopy);

                    messageBubble.on('mousedown touchstart', function (e) {
                        pressTimer = window.setTimeout(function() {
                            handleCopy();
                        }, 500); // 500ms for long press
                    }).on('mouseup touchend mouseleave', function (e) {
                        clearTimeout(pressTimer);
                    });
                }
            }
            
            function processMessageContent(content) {
                let processed = escapeHtml(content);
                // Regex to find URLs and emails
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const emailRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;

                // Process URLs and emails first, then handle newlines
                processed = processed
                    .replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>')
                    .replace(emailRegex, '<a href="mailto:$1">$1</a>')
                    .replace(/\n/g, '<br>');

                return processed;
            }

            function displayFileMessage(data) {
                const isMyMessage = data.username === "{{ session['username'] }}";
                const timestamp = formatTimestamp(data && data.timestamp);
                const fileSize = formatFileSize(data.file_size || 0);
                
                const messageElement = $(`
                    <div class="message-item file-message ${isMyMessage ? 'my-message' : ''}">
                        <div class="message-avatar" style="background: ${data.user_color};">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-username" style="color: ${data.user_color};">${data.username}</span>
                                <span class="message-time">${timestamp}</span>
                            </div>
                            <div class="file-card">
                                <div class="file-info">
                                    <div class="file-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="file-details">
                                        <div class="file-name">${data.filename}</div>
                                        <div class="file-size">${fileSize}</div>
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <a href="/download_temp/${data.file_id}" class="file-btn download-btn">
                                        <i class="fas fa-download"></i>
                                        Download
                                    </a>
                                    <button class="file-btn copy-link-btn" data-link="${data.shareable_link}">
                                        <i class="fas fa-link"></i>
                                        Copy Link
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);
                scrollToBottom();
                
                messageElement.find('.copy-link-btn').click(function() {
                    const link = $(this).data('link');
                    navigator.clipboard.writeText(link).then(() => {
                        $(this).html('<i class="fas fa-check"></i> Copied!');
                        setTimeout(() => {
                            $(this).html('<i class="fas fa-link"></i> Copy Link');
                        }, 2000);
                    });
                });
            }

            function addSystemMessage(message, type) {
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const icon = type === 'join' ? 'user-plus' : type === 'leave' ? 'user-minus' : 
                           type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
                
                const messageElement = $(`
                    <div class="system-message ${type}">
                        <div class="system-content">
                            <i class="fas fa-${icon}"></i>
                            <span>${message}</span>
                            <span class="system-time">${timestamp}</span>
                        </div>
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);
                scrollToBottom();
                
                if (type === 'success' || type === 'error' || type === 'info') {
                    setTimeout(() => {
                        messageElement.fadeOut(() => messageElement.remove());
                    }, 5000);
                }
            }
            
            function updateUserCount(count) {
                $("#user-count-header").text(count);
                $("#users-count").text(count);
            }
            
            function updateActiveUsers(users) {
                const usersList = $("#users-list");
                usersList.empty();
                
                if (users.length === 0) {
                    usersList.append('<div class="no-users">Only you are online</div>');
                    return;
                }
                
                users.forEach(user => {
                    const userElement = $(`
                        <div class="user-item">
                            <div class="user-avatar">
                                ${user.charAt(0).toUpperCase()}
                            </div>
                            <div class="user-info">
                                <span class="user-name">${user}</span>
                                <span class="user-status">Online</span>
                            </div>
                            <div class="status-indicator"></div>
                        </div>
                    `);
                    usersList.append(userElement);
                });
            }
            
            function updateTypingIndicator(typingUsers) {
                const indicator = $("#typing-indicator");
                const typingText = $("#typing-text");
                
                if (typingUsers.length === 0) {
                    indicator.hide();
                } else if (typingUsers.length === 1) {
                    const user = typingUsers[0];
                    const action = user.action === 'uploading_files' ? 'uploading files' : 'typing';
                    typingText.text(`${user.username} is ${action}...`);
                    indicator.show();
                } else if (typingUsers.length === 2) {
                    typingText.text(`${typingUsers[0].username} and ${typingUsers[1].username} are typing...`);
                    indicator.show();
                } else {
                    typingText.text(`${typingUsers.length} people are typing...`);
                    indicator.show();
                }
            }
            
            function scrollToBottom() {
                const container = $("#chat-messages");
                container.scrollTop(container[0].scrollHeight);
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function escapeHtmlAttr(text) {
                if (text == null) return '';
                return String(text)
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function formatTimestamp(isoString) {
                try {
                    if (!isoString) return new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const d = new Date(isoString);
                    if (isNaN(d.getTime())) return new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                } catch (_) {
                    return new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
            }

            // Connection error handling
            socket.on("connect_error", () => {
                addSystemMessage("Connection failed. Please try again.", "error");
            });

            socket.on("disconnect", () => {
                addSystemMessage("Disconnected from room.", "error");
            });

            // Drag and drop file upload
            const messagesArea = $(".messages-area");
            
            messagesArea.on('dragover', (e) => {
                e.preventDefault();
                messagesArea.addClass('drag-over');
            });
            
            messagesArea.on('dragleave', (e) => {
                e.preventDefault();
                messagesArea.removeClass('drag-over');
            });
            
            messagesArea.on('drop', (e) => {
                e.preventDefault();
                messagesArea.removeClass('drag-over');
                
                const files = Array.from(e.originalEvent.dataTransfer.files);
                if (files.length > 0) {
                    socket.emit("typing", { typing: true, action: 'uploading_files' });
                    
                    files.forEach((file, index) => {
                        setTimeout(() => {
                            uploadFile(file);
                        }, index * 500);
                    });
                    
                    setTimeout(() => {
                        socket.emit("typing", { typing: false, action: 'stopped' });
                    }, files.length * 500 + 1000);
                }
            });

            // Notification handling
            const notificationsToggle = $("#notifications-toggle");
            let notificationsEnabled = false;

            function initializeNotifications() {
                if ('serviceWorker' in navigator && 'PushManager' in window) {
                    console.log('Service Worker and Push is supported');
                    navigator.serviceWorker.register('/static/sw.js')
                        .then(swReg => {
                            console.log('Service Worker is registered', swReg);
                            notificationsToggle.click(() => toggleNotifications(swReg));
                        })
                        .catch(error => {
                            console.error('Service Worker Error', error);
                        });
                } else {
                    console.warn('Push messaging is not supported');
                    notificationsToggle.prop('disabled', true);
                }
            }

            function toggleNotifications(swReg) {
                console.log('Toggling notifications');
                if (notificationsEnabled) {
                    // Disable notifications
                    console.log('Disabling notifications');
                    notificationsEnabled = false;
                    notificationsToggle.removeClass('enabled');
                    showToast("Notifications Disabled", "You will no longer receive notifications for this room.", "info");
                } else {
                    // Enable notifications
                    console.log('Enabling notifications');
                    Notification.requestPermission().then(permission => {
                        console.log('Notification permission:', permission);
                        if (permission === 'granted') {
                            notificationsEnabled = true;
                            notificationsToggle.addClass('enabled');
                            showToast("Notifications Enabled", "You will now receive notifications for new messages.", "success");
                            subscribeUser(swReg);
                        } else {
                            showToast("Permission Denied", "You have blocked notifications.", "error");
                        }
                    });
                }
            }

            function subscribeUser(swReg) {
                console.log('Subscribing user');
                const applicationServerKey = urlB64ToUint8Array("{{ VAPID_PUBLIC_KEY }}");
                swReg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                })
                .then(subscription => {
                    console.log('User is subscribed:', subscription);
                    fetch('/save-subscription', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            subscription: subscription,
                            room_name: "{{ session['Room_Name'] }}"
                        }),
                    })
                    .then(response => response.json())
                    .then(data => console.log('Subscription saved on server:', data))
                    .catch(error => console.error('Error saving subscription:', error));
                })
                .catch(err => {
                    console.error('Failed to subscribe the user: ', err);
                });
            }

            function showToast(title, message, type = 'info') {
                const toastContainer = $('#notification-toast');
                const toast = $(`
                    <div class="toast">
                        <div class="toast-icon"><i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i></div>
                        <div class="toast-content">
                            <div class="toast-title">${title}</div>
                            <div class="toast-message">${message}</div>
                        </div>
                    </div>
                `);
                toastContainer.append(toast);
                setTimeout(() => {
                    toast.fadeOut(() => toast.remove());
                }, 5000);
            }

            function urlB64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding)
                    .replace(/\-/g, '+')
                    .replace(/_/g, '/');

                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);

                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }

            initializeNotifications();
        });
    </script>
</body>
</html>