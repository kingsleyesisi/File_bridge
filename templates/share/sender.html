<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Room: {{ session['Room_Name'] }} - FileBridge</title>
    <link rel="stylesheet" href="static/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/edec7f25e3.js" crossorigin="anonymous"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.slim.min.js" crossorigin="anonymous"></script>
    <link rel="shortcut icon" href="../../static/Filebridge.png" type="image/x-icon">
</head>

<body>
    <header>
        <h1><i class="fas fa-cloud-upload-alt"></i> FileBridge</h1>
    </header>

    <div class="main-container">
        <div class="room-header">
            <h2>
                <i class="fas fa-users"></i>
                Room: {{ session['Room_Name'] }}
            </h2>
            <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                Welcome, <strong>{{ session['username'] }}</strong>! Share files and chat with room members.
            </p>
            <div id="room-info" style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div id="user-count" style="background: var(--primary-color); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.875rem;">
                    <i class="fas fa-users"></i> <span id="count">1</span> user(s) online
                </div>
                <div id="typing-indicator" style="color: var(--text-secondary); font-style: italic; font-size: 0.875rem; min-height: 1.25rem;">
                </div>
            </div>
        </div>

        <div id="sending-page">
            <div class="chat-container" style="position: relative;">
                <div id="chat-messages" style="height: 400px; overflow-y: auto; padding: 1rem; background: var(--background); border-radius: var(--border-radius); border: 2px solid var(--border);">
                    <div class="welcome-message" style="text-align: center; color: var(--text-secondary); font-style: italic; margin-bottom: 1rem;">
                        Welcome to the room! Start chatting and sharing files.
                    </div>
                </div>
                
                <div id="active-users" style="position: absolute; top: 1rem; right: 1rem; background: rgba(255, 255, 255, 0.95); border-radius: var(--border-radius); padding: 0.5rem; box-shadow: var(--shadow); max-width: 200px;">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.25rem;">Active Users:</div>
                    <div id="users-list" style="font-size: 0.75rem;"></div>
                </div>
            </div>

            <div class="input-container">
                <textarea
                    id="sendinput"
                    placeholder="Type your message here..."
                    maxlength="10000"
                    rows="1"
                    style="resize: none; min-height: 44px; max-height: 120px; overflow-y: auto;"
                ></textarea>
                
                <input type="file" id="fileinput" style="display: none;" accept="*/*" multiple />
                <label for="fileinput" class="file-upload-btn" title="Upload File (Max 50MB)">
                    <i class="fas fa-paperclip"></i>
                </label>
                
                <button class="send-button" id="send-btn">
                    <i class="fas fa-paper-plane"></i>
                    Send
                </button>
            </div>

            <div style="text-align: center; margin-top: 1rem;">
                <button class="open-button" id="leave-room-btn" style="background: var(--error-color); font-size: 0.875rem; padding: 0.5rem 1rem;">
                    <i class="fas fa-sign-out-alt"></i>
                    Leave Room
                </button>
            </div>
        </div>
    </div>

    <!-- Leave Room Modal -->
    <dialog class="modal" id="modal">
        <h2>Leave Room?</h2>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">
            Are you sure you want to leave this room? You'll need to rejoin to continue the conversation.
        </p>
        <div class="modal-buttons">
            <button class="close-button-modal close-button">
                <i class="fas fa-times"></i>
                Cancel
            </button>
            <button class="leave-btn" id="leave-btn">
                <i class="fas fa-sign-out-alt"></i>
                Leave Room
            </button>
        </div>
    </dialog>

    <footer id="footer">
        <div>
            <a href="/main">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
        </div>
        <div class="active">
            <a href="/receiver">
                <i class="fas fa-share-alt"></i>
                <span>Transfer</span>
            </a>
        </div>
        <div>
            <a href="/instructions">
                <i class="fas fa-book-open"></i>
                <span>Guide</span>
            </a>
        </div>
        <div>
            <a href="/about">
                <i class="fas fa-user-group"></i>
                <span>About</span>
            </a>
        </div>
    </footer>

    <script>
        // Enhanced Socket.IO implementation with better file handling
        $(document).ready(() => {
            let socket = io.connect("/sender");
            let typingTimer;
            let isTyping = false;
            
            // Connection handling
            socket.on("connect", () => {
                socket.emit("sender", {});
            });

            // Status messages
            socket.on("status", (data) => {
                addSystemMessage(data.msg, data.type || "info");
            });
            
            // User list updates
            socket.on("user_list_update", (data) => {
                updateUserCount(data.user_count);
                updateActiveUsers(data.users);
            });
            
            // Typing indicator updates
            socket.on("typing_update", (data) => {
                updateTypingIndicator(data.typing_users);
            });

            // Send message
            $("#send-btn").click((e) => {
                e.preventDefault();
                sendMessage();
            });

            $("#sendinput").keydown((e) => {
                if (e.which === 13 && !e.shiftKey) { // Enter key without Shift
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            $("#sendinput").on('input', handleTyping);
            $("#sendinput").on('input', autoResizeTextarea);
            
            function autoResizeTextarea() {
                const textarea = $("#sendinput")[0];
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            function sendMessage() {
                const text = $("#sendinput").val().trim();
                if (text) {
                    $("#sendinput").val("");
                    autoResizeTextarea();
                    socket.emit("text", { msg: text });
                    stopTyping();
                }
            }
            
            function handleTyping() {
                if (!isTyping) {
                    isTyping = true;
                    socket.emit("typing", { typing: true, action: 'typing' });
                }
                
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    stopTyping();
                }, 2000);
            }
            
            function stopTyping() {
                if (isTyping) {
                    isTyping = false;
                    socket.emit("typing", { typing: false, action: 'stopped' });
                }
                clearTimeout(typingTimer);
            }

            // Handle incoming messages
            socket.on("message", (data) => {
                if (data.message_type === 'file') {
                    displayFileMessage(data);
                } else {
                    displayTextMessage(data);
                }
            });

            // File upload handling
            $("#fileinput").change((e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    // Show file selection indicator
                    socket.emit("typing", { typing: true, action: 'selecting_files' });
                    
                    files.forEach((file, index) => {
                        setTimeout(() => {
                            uploadFile(file);
                        }, index * 500); // Stagger uploads
                    });
                    
                    $("#fileinput").val("");
                    
                    // Stop file selection indicator after uploads
                    setTimeout(() => {
                        socket.emit("typing", { typing: false, action: 'stopped' });
                    }, files.length * 500 + 1000);
                }
            });
            
            function uploadFile(file) {
                // Check file size (50MB limit)
                const maxSize = 50 * 1024 * 1024; // 50MB in bytes
                if (file.size > maxSize) {
                    addSystemMessage(`File "${file.name}" exceeds 50MB limit. Please choose a smaller file.`, "error");
                    return;
                }

                addSystemMessage(`Uploading ${file.name}...`, "info");
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    socket.emit("file", { 
                        file: event.target.result, 
                        fileName: file.name, 
                        fileType: file.type,
                        fileSize: file.size
                    });
                };
                reader.readAsDataURL(file);
            }

            // Leave room functionality
            $("#leave-room-btn").click(() => {
                $("#modal").get(0).showModal();
            });

            $(".close-button").click(() => {
                $("#modal").get(0).close();
            });

            $(".leave-btn").click(() => {
                socket.emit("left", {}, () => {
                    socket.disconnect();
                    window.location.href = "/receiver";
                });
            });

            // Helper functions
            function displayTextMessage(data) {
                const timestamp = new Date().toLocaleTimeString();
                const isCode = data.message_type === 'code';
                const processedContent = processMessageContent(data.content);
                
                const messageElement = $(`
                    <div class="message" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: var(--border-radius); background: var(--surface); border-left: 3px solid ${data.user_color};">
                        <div class="message-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span class="username" style="font-weight: 600; color: ${data.user_color};">${data.username}</span>
                            <span class="timestamp" style="font-size: 0.75rem; color: var(--text-secondary);">${timestamp}</span>
                        </div>
                        <div class="message-content ${isCode ? 'code-content' : 'text-content'}" style="${isCode ? 'background: #f8f9fa; padding: 0.75rem; border-radius: 4px; font-family: Monaco, Consolas, monospace; font-size: 0.875rem; white-space: pre-wrap; overflow-x: auto; border: 1px solid #e9ecef;' : 'white-space: pre-wrap; word-wrap: break-word; line-height: 1.5;'}">${processedContent}</div>
                        ${isCode ? '<div style="margin-top: 0.5rem;"><button class="copy-code-btn" style="background: var(--primary-color); color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;"><i class="fas fa-copy"></i> Copy Code</button></div>' : ''}
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);
                scrollToBottom();
                
                // Add copy functionality for code blocks
                if (isCode) {
                    messageElement.find('.copy-code-btn').click(function() {
                        navigator.clipboard.writeText(data.content).then(() => {
                            $(this).html('<i class="fas fa-check"></i> Copied!');
                            setTimeout(() => {
                                $(this).html('<i class="fas fa-copy"></i> Copy Code');
                            }, 2000);
                        });
                    });
                }
            }
            
            function processMessageContent(content) {
                // First escape HTML to prevent XSS
                let processed = escapeHtml(content);
                
                // Convert URLs to clickable links
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                processed = processed.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color); text-decoration: underline;">$1</a>');
                
                // Convert email addresses to clickable links
                const emailRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;
                processed = processed.replace(emailRegex, '<a href="mailto:$1" style="color: var(--primary-color); text-decoration: underline;">$1</a>');
                
                return processed;
            }

            function displayFileMessage(data) {
                const timestamp = new Date().toLocaleTimeString();
                const fileSize = formatFileSize(data.file_size || 0);
                
                const messageElement = $(`
                    <div class="message file-message" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: var(--border-radius); background: var(--surface); border-left: 3px solid ${data.user_color};">
                        <div class="message-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span class="username" style="font-weight: 600; color: ${data.user_color};">${data.username}</span>
                            <span class="timestamp" style="font-size: 0.75rem; color: var(--text-secondary);">${timestamp}</span>
                        </div>
                        <div class="file-content" style="background: #f0f9ff; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #0ea5e9;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <i class="fas fa-file" style="font-size: 1.5rem; color: var(--primary-color);"></i>
                                <div class="file-info" style="flex: 1;">
                                    <div class="file-name" style="font-weight: 500; color: var(--text-primary);">${data.filename}</div>
                                    <div class="file-size" style="font-size: 0.875rem; color: var(--text-secondary);">Size: ${fileSize}</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <a href="/download_temp/${data.file_id}" class="download-btn" style="background: var(--success-color); color: white; padding: 0.5rem 1rem; border-radius: var(--border-radius); text-decoration: none; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.25rem;">
                                    <i class="fas fa-download"></i> Download
                                </a>
                                <button class="copy-link-btn" data-link="${data.shareable_link}" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--border-radius); font-size: 0.875rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.25rem;">
                                    <i class="fas fa-link"></i> Copy Link
                                </button>
                            </div>
                        </div>
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);
                scrollToBottom();
                
                // Add copy link functionality
                messageElement.find('.copy-link-btn').click(function() {
                    const link = $(this).data('link');
                    navigator.clipboard.writeText(link).then(() => {
                        $(this).html('<i class="fas fa-check"></i> Copied!');
                        setTimeout(() => {
                            $(this).html('<i class="fas fa-link"></i> Copy Link');
                        }, 2000);
                    });
                });
            }

            function addSystemMessage(message, type) {
                const timestamp = new Date().toLocaleTimeString();
                const icon = type === 'join' ? 'user-plus' : type === 'leave' ? 'user-minus' : type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
                const color = type === 'join' ? 'var(--success-color)' : type === 'leave' ? 'var(--error-color)' : type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--error-color)' : 'var(--text-secondary)';
                
                const messageElement = $(`
                    <div class="system-message" style="margin-bottom: 1rem; padding: 0.5rem 1rem; border-radius: var(--border-radius); background: rgba(100, 116, 139, 0.1); text-align: center; font-style: italic; color: ${color};">
                        <i class="fas fa-${icon}" style="margin-right: 0.5rem;"></i>
                        ${message}
                        <span style="margin-left: 0.5rem; font-size: 0.75rem; opacity: 0.7;">${timestamp}</span>
                    </div>
                `);
                
                $("#chat-messages").append(messageElement);
                scrollToBottom();
                
                // Auto-remove status messages after 5 seconds
                if (type === 'success' || type === 'error') {
                    setTimeout(() => {
                        messageElement.fadeOut(() => messageElement.remove());
                    }, 5000);
                }
            }
            
            function updateUserCount(count) {
                $("#count").text(count);
            }
            
            function updateActiveUsers(users) {
                const usersList = $("#users-list");
                usersList.empty();
                users.forEach(user => {
                    usersList.append(`<div style="margin-bottom: 0.125rem; color: var(--text-primary);">â€¢ ${user}</div>`);
                });
            }
            
            function updateTypingIndicator(typingUsers) {
                const indicator = $("#typing-indicator");
                if (typingUsers.length === 0) {
                    indicator.text("");
                } else if (typingUsers.length === 1) {
                    const user = typingUsers[0];
                    const action = user.action === 'selecting_files' ? 'selecting files' : 'typing';
                    indicator.html(`<i class="fas fa-${user.action === 'selecting_files' ? 'file' : 'keyboard'}"></i> ${user.username} is ${action}...`);
                } else if (typingUsers.length === 2) {
                    indicator.html(`<i class="fas fa-keyboard"></i> ${typingUsers[0].username} and ${typingUsers[1].username} are typing...`);
                } else {
                    indicator.html(`<i class="fas fa-keyboard"></i> ${typingUsers.length} people are typing...`);
                }
            }
            
            function scrollToBottom() {
                const chatMessages = $("#chat-messages");
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Connection error handling
            socket.on("connect_error", () => {
                addSystemMessage("Connection failed. Please try again.", "error");
            });

            socket.on("disconnect", () => {
                addSystemMessage("Disconnected from room.", "error");
            });
        });
    </script>
</body>
</html>